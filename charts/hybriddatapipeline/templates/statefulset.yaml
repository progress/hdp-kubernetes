{{- $reqMem := (toString (default "4096Mi" .Values.hdp.resources.requests.memory)) -}}
{{- $limMem := (toString (default "4096Mi" .Values.hdp.resources.limits.memory)) -}}
{{- $reqCpu := (toString (default "2000m" .Values.hdp.resources.requests.cpu)) -}}
{{- $limCpu := (toString (default "2000m" .Values.hdp.resources.limits.cpu)) -}}
# Call the validation helper
{{- include "hdp.resources.validate" (dict "requests" (dict "memory" $reqMem "cpu" $reqCpu) "limits" (dict "memory" $limMem "cpu" $limCpu)) }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels: {{- include "hdp.labels.merge" (dict "commonLabels" .Values.hdp.commonLabels "specificLabels" .Values.hdp.labels "context" .) | nindent 8 }}
  annotations: {{- include "hdp.annotations.merge" (dict "commonAnnotations" .Values.hdp.commonAnnotations "specificAnnotations" .Values.hdp.annotations "context" .) | nindent 4 }}
  name: {{ .Release.Name }}-{{ .Values.hdp.services.hdpService.name }}
  namespace: {{ .Release.Namespace }}
spec:
  serviceName: {{ .Release.Name }}-{{ .Values.hdp.services.hdpService.name }}
  replicas: {{ .Values.hdp.replicaCount }}
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels: {{- include "hybriddatapipeline.selectorLabels" . | nindent 8 }}
  template: 
    metadata:
      labels:
{{- include "hdp.labels.merge" (dict "commonLabels" .Values.hdp.commonLabels "specificLabels" .Values.hdp.podLabels "context" .) | nindent 8 }}
      annotations: {{- include "hdp.annotations.merge" (dict "commonAnnotations" .Values.hdp.commonAnnotations "specificAnnotations" .Values.hdp.podAnnotations "context" .) | nindent 8 }}
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 12321
        runAsGroup: 12321
        fsGroup: 12321
        seccompProfile:
          type: RuntimeDefault
      {{- with .Values.hdp.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.hdp.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      initContainers:
      # PostgreSQL Database Initialization - runs at every startup
      {{- if .Values.hdp.database.postgres.enabled }}
      - name: postgres-db-init
        image: {{ .Values.postgresql.image.registry }}/{{ .Values.postgresql.image.repository }}:{{ .Values.postgresql.image.tag }}
        env:
        - name: PGHOST
          value: "{{ .Release.Name }}-{{ .Values.hdp.database.postgres.hostName }}{{ if eq .Values.postgresql.architecture "replication" }}-primary{{ end }}"
        - name: PGPORT
          value: "{{ .Values.hdp.database.postgres.port }}"
        - name: PGUSER
          value: "postgres"
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Values.postgresql.global.postgresql.auth.existingSecret }}
              key: {{ .Values.postgresql.global.postgresql.auth.secretKeys.adminPasswordKey }}
        - name: PGDATABASE
          value: {{ .Values.postgresql.global.postgresql.auth.database }}
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "=== HDP PostgreSQL Database Initialization - Startup ==="
          
          # Wait for PostgreSQL primary to be ready
          echo "Waiting for PostgreSQL primary..."
          until pg_isready -h $PGHOST -p $PGPORT -U $PGUSER; do
            echo "PostgreSQL not ready, waiting..."
            sleep 5
          done
          echo "âœ… PostgreSQL primary is ready"
          
          # Check if HDP database already exists
          if psql -h $PGHOST -p $PGPORT -U $PGUSER -lqt | cut -d \| -f 1 | grep -qw {{ .Values.hdp.database.postgres.databaseName }}; then
            echo "âœ… HDP database already exists, skipping initialization"
            exit 0
          fi
          
          echo "ðŸ”§ Executing HDP database initialization script..."
          # Execute the initialization script
          bash /postgres-init/init.sh
          echo "âœ… HDP database initialization completed successfully"
          
        volumeMounts:
        - name: postgres-init-scripts
          mountPath: /postgres-init
          readOnly: true
        securityContext:
          runAsNonRoot: {{.Values.hdp.containerSecurityContext.runAsNonRoot }}
          runAsUser: 12321
          runAsGroup: 12321
          readOnlyRootFilesystem: {{.Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          seccompProfile:
            type: RuntimeDefault
        resources:
          requests:
            memory: "512Mi"
            cpu: "200m"
          limits:
            memory: "1Gi"
            cpu: "500m"
      {{- end }}
      - name: init-properties
        image: "{{.Values.hdp.image.repository}}:{{.Values.hdp.image.tag}}"
        imagePullPolicy: {{.Values.hdp.image.pullPolicy}}
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: {{.Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
          runAsNonRoot: {{.Values.hdp.containerSecurityContext.runAsNonRoot }}
          runAsUser: 12321
          runAsGroup: 12321
          capabilities:
            drop:
              - ALL
          seccompProfile:
            type: RuntimeDefault
        command:
          - "/bin/sh"
          - "-c"
          - |
            {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
            # Copy user files to app directory
            cp -Rv /home/hdpuser/* /app
            {{- end }}
            
            # Create shared directory and copy properties
            mkdir -p /hdpshare
            cp /hdpprops/*.properties /hdpshare/
            echo 'Config Map mounted and properties file copied to /hdpshare!'
            
            {{- if .Values.hdp.hdpingressconfiguration.tls.enabled }}
            # Copy TLS certificates
            cat /certs/tls.crt /certs/tls.key > /hdpshare/hdp-cert.pem
            echo 'Certificate copied to /hdpshare!'
            {{- end }}
            
            # Detect Java installation
            {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
            SEARCH_PATH="/app"
            {{- else }}
            SEARCH_PATH="/home/hdpuser"
            {{- end }}
            
            JAVA_EXECUTABLE=$(find $SEARCH_PATH -name 'java' -type f -path '*/bin/java' 2>/dev/null | head -1)
            if [ -n "$JAVA_EXECUTABLE" ] && [ -x "$JAVA_EXECUTABLE" ]; then
              JAVA_HOME_PATH=$(dirname $(dirname $JAVA_EXECUTABLE))
              echo "$JAVA_HOME_PATH" > /hdpshare/java_home.txt
              echo "JRE detected at: $JAVA_HOME_PATH (executable: $JAVA_EXECUTABLE)"
            else
              echo "" > /hdpshare/java_home.txt
              echo "No valid Java executable found in $SEARCH_PATH"
            fi
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        volumeMounts:
        {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
        - name: hdp-app
          mountPath: /app
        {{- end }}  
        - name: properties
          mountPath: /hdpprops
        {{- if .Values.hdp.hdpingressconfiguration.tls.enabled }}
        - name: certs
          mountPath: /certs
        {{- end }}  
        - name: shared-storage-volume
          mountPath: /hdpshare
      containers:
        - name: hdp-server
          image: "{{.Values.hdp.image.repository}}:{{.Values.hdp.image.tag}}"
          imagePullPolicy: {{.Values.hdp.image.pullPolicy}}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: {{.Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
            runAsNonRoot: {{.Values.hdp.containerSecurityContext.runAsNonRoot }}
            runAsUser: 12321
            runAsGroup: 12321
            capabilities:
                drop:   
                 - ALL    
            seccompProfile:
              type: RuntimeDefault
          command:
            - "/bin/sh"
            - "-c"
            - |
              # Set Java Home if detected
              if [ -f /hdpshare/java_home.txt ]; then
                export HDP_JAVA_HOME=$(cat /hdpshare/java_home.txt)
                echo "Using JRE at: $HDP_JAVA_HOME"
                # Clean up the temporary file after use
                rm -f /hdpshare/java_home.txt
              fi
              
              # Start HDP server
              {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
              ${HDP_INSTALL_HOME}/Progress/DataDirect/scripts/startup.sh
              {{- else }}
              /home/hdpuser/Progress/DataDirect/scripts/startup.sh
              {{- end }}
          ports:
            - name: hdpserver
              containerPort: {{.Values.hdp.ports.hdpServer.port}}
            - name: opaccessor
              containerPort: {{.Values.hdp.ports.opAccessor.port}}
            - name: notification
              containerPort: {{.Values.hdp.ports.notificationServer.port}}
            - name: internal
              containerPort: 8190
          env:
          {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
            - name: HDP_INSTALL_HOME
              value: /app
          {{- end }}
            - name: ACCEPT_EULA
              value: "{{.Values.hdp.eula.accepted}}"
            - name: HDP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: hdp-admin-password
            - name: HDP_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: hdp-user-password
            - name: HDP_DATABASE_ADMIN
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: account-database-admin-username
            - name: HDP_DATABASE_ADMIN_PASSWORD 
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: account-database-admin-password
            - name: HDP_DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: account-database-user-username
            - name: HDP_DATABASE_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: account-database-user-password
            - name: HDP_LICENSE_KEY
              valueFrom:
                secretKeyRef:
                  name: hdp-secrets
                  key: hdp-license-key
          volumeMounts:
          {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
          - name: hdp-app
            mountPath: /app
          - name: driver-schema-cache
            mountPath: /home/hdpuser
          - name: jvm-perf-cache
            mountPath: /tmp
          {{- end }}  
          - name: properties
            mountPath: /hdpprops
          - name: shared-storage-volume
            mountPath: {{ .Values.hdp.persistence.keystore.mountPath }}
          {{- if .Values.hdp.persistence.logs.enabled }}
          - name: logs-storage-volume
            mountPath: {{ .Values.hdp.persistence.logs.mountPath }}
          {{- end }}
          {{- if .Values.hdp.livenessProbe.enabled }}
          livenessProbe:
            httpGet:
              path: /
              port: {{.Values.hdp.ports.hdpServer.port}}
            initialDelaySeconds: {{ .Values.hdp.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.hdp.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.hdp.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.hdp.livenessProbe.failureThreshold }}
            successThreshold: {{ .Values.hdp.livenessProbe.successThreshold }}
          {{- end }}
          {{- if .Values.hdp.readinessProbe.enabled }}
          readinessProbe:
            httpGet:
              path: /
              port: {{.Values.hdp.ports.hdpServer.port}}
            initialDelaySeconds: {{ .Values.hdp.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.hdp.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.hdp.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.hdp.readinessProbe.failureThreshold }}
            successThreshold: {{ .Values.hdp.readinessProbe.successThreshold }}
          {{- end }}
          {{- if .Values.hdp.startupProbe.enabled }}
          startupProbe:
            httpGet:
              path: /
              port: {{.Values.hdp.ports.hdpServer.port}}
            initialDelaySeconds: {{ .Values.hdp.startupProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.hdp.startupProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.hdp.startupProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.hdp.startupProbe.failureThreshold }}
            successThreshold: {{ .Values.hdp.startupProbe.successThreshold }}
          {{- end }}
          resources:
            requests:
              memory: {{ $reqMem | quote }}
              cpu: {{ $reqCpu | quote }}
            limits:
              memory: {{ $limMem | quote }}
              cpu: {{ $limCpu | quote }}       
      volumes:
        # PostgreSQL initialization scripts (available to main container)
        {{- if .Values.hdp.database.postgres.enabled }}
        - name: postgres-init-scripts
          secret:
            secretName: {{ include "hybriddatapipeline.fullname" . }}-postgres-init
            defaultMode: 0755
        {{- end }}
        {{- if .Values.hdp.containerSecurityContext.readOnlyRootFilesystem }}
        - name: hdp-app
          emptyDir: {}
        - name: driver-schema-cache
          emptyDir:
            medium: Memory
        - name: jvm-perf-cache
          emptyDir:
            medium: Memory
        {{- end }}    
        - name: shared-storage-volume
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-shared-storage-volume
        {{- if .Values.hdp.persistence.logs.enabled }}
        - name: logs-storage-volume
          persistentVolumeClaim:
            claimName: {{ .Release.Name }}-logs-storage-volume
        {{- end }}
        - name: properties
          projected: 
            sources:
              - configMap:
                  name: {{ .Release.Name }}-configmap
              {{- if .Values.hdp.persistence.logs.enabled }}
              - configMap:
                  name: {{ .Release.Name }}-logging-properties-configmap
              {{- end }}
        {{- if .Values.hdp.hdpingressconfiguration.tls.enabled }}
        - name: certs
          secret:
            secretName: {{ .Values.hdp.hdpingressconfiguration.tls.secretName }}
        {{- end }}
      {{- if .Values.hdp.imagePullSecrets }}
      imagePullSecrets: 
      {{- range .Values.hdp.imagePullSecrets }}
        - name: {{ . }}
      {{- end }}
      {{- end }}
