suite: postgresql-integration
templates:
  - configmap.yaml
tests:
  # Test PostgreSQL replication integration - ConfigMap should use primary hostname
  - it: should integrate postgresql replication settings with configmap template
    set:
      hdp.database.postgres.enabled: true
      hdp.database.postgres.hostName: postgresql
      postgresql.architecture: replication
      postgresql.auth.existingSecret: "account-database-secrets"
      postgresql.auth.replicationUsername: repl_user
      postgresql.auth.secretKeys.replicationPasswordKey: replication-password
      postgresql.replication.synchronousCommit: "remote_apply"
      postgresql.replication.numSynchronousReplicas: 1
      postgresql.replication.applicationName: hdp
      postgresql.readReplicas.replicaCount: 2
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-configmap
      - matchRegex:
          path: data["hdpdeploy.properties"]
          pattern: "HDP_DATABASE_HOSTNAME=RELEASE-NAME-postgresql-primary"

  # Test PostgreSQL standalone integration - ConfigMap should use regular hostname
  - it: should integrate postgresql standalone settings with configmap template
    set:
      hdp.database.postgres.enabled: true
      hdp.database.postgres.hostName: postgresql
      postgresql.architecture: standalone
      postgresql.auth.existingSecret: "account-database-secrets"
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-configmap
      - matchRegex:
          path: data["hdpdeploy.properties"]
          pattern: "HDP_DATABASE_HOSTNAME=RELEASE-NAME-postgresql"

  # Test backward compatibility - should use default value from values.yaml
  - it: should maintain backward compatibility when postgresql.architecture is not specified
    set:
      hdp.database.postgres.enabled: true
      hdp.database.postgres.hostName: postgresql
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-configmap
      - matchRegex:
          path: data["hdpdeploy.properties"]
          pattern: "HDP_DATABASE_HOSTNAME=RELEASE-NAME-postgresql"
