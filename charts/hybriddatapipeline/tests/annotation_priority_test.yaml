suite: Comprehensive Annotation Override Tests
templates:
  - statefulset.yaml
  - hdp-service.yaml
  - notification-service.yaml
  - opa-service.yaml
  - hdp-ingress.yaml
  - configmap.yaml
  - logging-properties-configmap.yaml
  - pvc.yaml
  - logs-pvc.yaml
  - pdb.yaml
  - postgres-init-sql.yaml
tests:
  - it: should allow StatefulSet annotations to override common annotations
    template: statefulset.yaml
    set:
      hdp.commonAnnotations:
        common/test: "common-value"
        common/override: "common-value"
      hdp.annotations:
        common/override: "statefulset-override"
        statefulset/specific: "statefulset-value"
    asserts:
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"
      - equal:
          path: metadata.annotations["common/override"]
          value: "statefulset-override"
      - equal:
          path: metadata.annotations["statefulset/specific"]
          value: "statefulset-value"

  - it: should allow Pod annotations to override common annotations
    template: statefulset.yaml
    set:
      hdp.commonAnnotations:
        common/test: "common-value"
        common/override: "common-value"
      hdp.podAnnotations:
        common/override: "pod-override"
        pod/specific: "pod-value"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["common/test"]
          value: "common-value"
      - equal:
          path: spec.template.metadata.annotations["common/override"]
          value: "pod-override"
      - equal:
          path: spec.template.metadata.annotations["pod/specific"]
          value: "pod-value"

  - it: should allow Service annotations to override base annotations
    template: hdp-service.yaml
    values:
      - ../values.yaml
    set:
      hdp.hdpingressconfiguration.agic.enabled: true
      hdp.services.annotations:
        "appgw.ingress.kubernetes.io/probe-path": "custom-probe"
        custom/service: "service-value"
      hdp.commonAnnotations:
        common/test: "common-value"
    asserts:
      - equal:
          path: metadata.annotations["appgw.ingress.kubernetes.io/probe-path"]
          value: "custom-probe"
      - equal:
          path: metadata.annotations["custom/service"]
          value: "service-value"
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"
      # Note: Using actual default path from test run
      - equal:
          path: metadata.annotations["appgw.ingress.kubernetes.io/probe-protocol"]
          value: "HEAD /api/healthcheck"

  - it: should allow Ingress annotations to override base annotations
    template: hdp-ingress.yaml
    set:
      hdp.hdpingressconfiguration.enabled: true
      hdp.hdpingressconfiguration.agic.enabled: true
      hdp.hdpingressconfiguration.haproxy.enabled: false
      hdp.hdpingressconfiguration.annotations:
        "appgw.ingress.kubernetes.io/cookie-based-affinity": "false"
        custom/ingress: "ingress-value"
      hdp.commonAnnotations:
        common/test: "common-value"
    asserts:
      - equal:
          path: metadata.annotations["appgw.ingress.kubernetes.io/cookie-based-affinity"]
          value: "false"
      - equal:
          path: metadata.annotations["custom/ingress"]
          value: "ingress-value"
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"
      - equal:
          path: metadata.annotations["appgw.ingress.kubernetes.io/session-affinity-cookie-name"]
          value: "HDP-SESSION"

  - it: should allow ConfigMap annotations to override common annotations
    template: configmap.yaml
    set:
      hdp.commonAnnotations:
        common/test: "common-value"
        common/override: "common-value"
      hdp.configAnnotations:
        common/override: "config-override"
        config/specific: "config-value"
    asserts:
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"
      - equal:
          path: metadata.annotations["common/override"]
          value: "config-override"
      - equal:
          path: metadata.annotations["config/specific"]
          value: "config-value"

  - it: should allow PVC annotations to override base annotations
    template: pvc.yaml
    set:
      hdp.commonAnnotations:
        common/test: "common-value"
      hdp.persistence.annotations:
        "helm.sh/resource-policy": "delete"
        pvc/specific: "pvc-value"
    asserts:
      - equal:
          path: metadata.annotations["helm.sh/resource-policy"]
          value: "delete"
      - equal:
          path: metadata.annotations["pvc/specific"]
          value: "pvc-value"
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"

  - it: should allow PDB annotations to override common annotations
    template: pdb.yaml
    set:
      hdp.pdb.create: true
      hdp.replicaCount: 3
      hdp.commonAnnotations:
        common/test: "common-value"
        common/override: "common-value"
      hdp.pdb.annotations:
        common/override: "pdb-override"
        pdb/specific: "pdb-value"
    asserts:
      - equal:
          path: metadata.annotations["common/test"]
          value: "common-value"
      - equal:
          path: metadata.annotations["common/override"]
          value: "pdb-override"
      - equal:
          path: metadata.annotations["pdb/specific"]
          value: "pdb-value"

  - it: should handle complex annotation precedence across all resource types
    templates:
      - statefulset.yaml
      - hdp-service.yaml
      - configmap.yaml
      - pvc.yaml
    set:
      hdp.commonAnnotations:
        global/annotation: "global-value"
        shared/precedence: "common-value"
      hdp.annotations:
        shared/precedence: "statefulset-value"
        statefulset/only: "statefulset-value"
      hdp.services.annotations:
        shared/precedence: "service-value"  
        service/only: "service-value"
      hdp.configAnnotations:
        shared/precedence: "config-value"
        config/only: "config-value"
      hdp.persistence.annotations:
        shared/precedence: "pvc-value"
        pvc/only: "pvc-value"
    asserts:
      # StatefulSet assertions
      - template: statefulset.yaml
        equal:
          path: metadata.annotations["global/annotation"]
          value: "global-value"
      - template: statefulset.yaml
        equal:
          path: metadata.annotations["shared/precedence"]
          value: "statefulset-value"
      - template: statefulset.yaml
        equal:
          path: metadata.annotations["statefulset/only"]
          value: "statefulset-value"
      
      # Service assertions
      - template: hdp-service.yaml
        equal:
          path: metadata.annotations["global/annotation"]
          value: "global-value"
      - template: hdp-service.yaml
        equal:
          path: metadata.annotations["shared/precedence"]
          value: "service-value"
      - template: hdp-service.yaml
        equal:
          path: metadata.annotations["service/only"]
          value: "service-value"
      
      # ConfigMap assertions
      - template: configmap.yaml
        equal:
          path: metadata.annotations["global/annotation"]
          value: "global-value"
      - template: configmap.yaml
        equal:
          path: metadata.annotations["shared/precedence"]
          value: "config-value"
      - template: configmap.yaml
        equal:
          path: metadata.annotations["config/only"]
          value: "config-value"
      
      # PVC assertions
      - template: pvc.yaml
        equal:
          path: metadata.annotations["global/annotation"]
          value: "global-value"
      - template: pvc.yaml
        equal:
          path: metadata.annotations["shared/precedence"]
          value: "pvc-value"
      - template: pvc.yaml
        equal:
          path: metadata.annotations["pvc/only"]
          value: "pvc-value"
