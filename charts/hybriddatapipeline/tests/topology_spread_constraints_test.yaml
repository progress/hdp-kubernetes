suite: Topology Spread Constraints Tests
templates:
  - statefulset.yaml
chart:
  version: 1.0.1
tests:
  # Test 1: Default behavior - no topology spread constraints configured
  - it: should not render topology spread constraints when not configured
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints: []
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - notExists:
          path: spec.template.spec.topologySpreadConstraints

  # Test 2: Basic zone distribution
  - it: should render basic zone distribution correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "topology.kubernetes.io/zone"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].whenUnsatisfiable
          value: "DoNotSchedule"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].labelSelector.matchLabels["app.kubernetes.io/name"]
          value: "hdp"

  # Test 3: Multi-domain distribution (zones + nodes)
  - it: should render multi-domain distribution correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
      - maxSkew: 2
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - lengthEqual:
          path: spec.template.spec.topologySpreadConstraints
          count: 2
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "topology.kubernetes.io/zone"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].maxSkew
          value: 2
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].topologyKey
          value: "kubernetes.io/hostname"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].whenUnsatisfiable
          value: "ScheduleAnyway"

  # Test 4: AWS-specific topology keys
  - it: should handle AWS EKS topology keys correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: failure-domain.beta.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
      - maxSkew: 1
        topologyKey: karpenter.sh/nodepool
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "failure-domain.beta.kubernetes.io/zone"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].topologyKey
          value: "karpenter.sh/nodepool"

  # Test 5: Azure AKS topology keys
  - it: should handle Azure AKS topology keys correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: failure-domain.beta.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
      - maxSkew: 2
        topologyKey: agentpool
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "failure-domain.beta.kubernetes.io/zone"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].topologyKey
          value: "agentpool"

  # Test 6: Google GKE topology keys
  - it: should handle Google GKE topology keys correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: failure-domain.beta.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
      - maxSkew: 1
        topologyKey: cloud.google.com/gke-nodepool
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].topologyKey
          value: "cloud.google.com/gke-nodepool"

  # Test 7: Production configuration with minDomains
  - it: should render production configuration with minDomains correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
        minDomains: 3
      - maxSkew: 3
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].minDomains
          value: 3
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].maxSkew
          value: 3

  # Test 8: Integration with affinity
  - it: should work alongside affinity configuration
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/arch
                operator: In
                values: ["amd64"]
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.affinity.nodeAffinity
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.affinity.nodeAffinity.requiredDuringSchedulingIgnoredDuringExecution.nodeSelectorTerms[0].matchExpressions[0].key
          value: "kubernetes.io/arch"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].topologyKey
          value: "topology.kubernetes.io/zone"

  # Test 9: Complex label selectors
  - it: should handle complex label selectors correctly
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
            app.kubernetes.io/component: server
          matchExpressions:
          - key: tier
            operator: In
            values: ["backend", "database"]
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].labelSelector.matchLabels["app.kubernetes.io/component"]
          value: "server"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].labelSelector.matchExpressions[0].key
          value: "tier"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].labelSelector.matchExpressions[0].operator
          value: "In"

  # Test 10: All whenUnsatisfiable options
  - it: should support all whenUnsatisfiable options
    set:
      hdp.eula.accepted: true
      hdp.image.repository: "test-repo"
      hdp.image.tag: "test-tag"
      hdp.topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: topology.kubernetes.io/zone
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
      - maxSkew: 2
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: hdp
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: StatefulSet
      - exists:
          path: spec.template.spec.topologySpreadConstraints
      - equal:
          path: spec.template.spec.topologySpreadConstraints[0].whenUnsatisfiable
          value: "DoNotSchedule"
      - equal:
          path: spec.template.spec.topologySpreadConstraints[1].whenUnsatisfiable
          value: "ScheduleAnyway"
